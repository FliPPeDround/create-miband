// 图片资源前缀
var IMAGE_PRE="watchface/assets/",ctx="",imageMap={},currentMode=hmUI.show_level.ONLY_NORMAL;$(function(){ctx=document.getElementById("canvas").getContext("2d")});function refreshCanvasUI(){(new Date).getTime();if(ctx){ctx.fillStyle="#000000";ctx.fillRect(0,0,192,490);var c=getInVisibleWds();currentMode="1"==engine_set.model?hmUI.show_level.ONLY_AOD:hmUI.show_level.ONLY_NORMAL;for(var d=0;d<hmUI.widgets.length;d++){var b=hmUI.widgets[d];if(b.visible&&!c[b.id+""]){var a=b.param;if(inShowLevel(currentMode,a.show_level)){b.x=a.x;b.y=a.y;b.w=a.w;b.h=a.h;if(b.type==hmUI.widget.TEXT)if(a.text_style==hmUI.text_style.WRAP)ctx.fillStyle=converColorNum(a.color),ctx.fillTextMuilline(ctx,a);else{ctx.font=""+a.text_size+"px \u9ed1\u4f53";ctx.fillStyle=converColorNum(a.color);ctx.textAlign="left";ctx.textBaseline="top";var e=ctx.measureText(a.text).width,f=0;a.w&&a.w>e&&(a.align_h==hmUI.align.CENTER_H?f=Math.round((a.w-e)/2):a.align_h==hmUI.align.RIGHT&&(f=a.w-e));ctx.fillText(a.text,a.x+f,a.y);a.w||(b.w=e);a.h||(b.h=a.text_size)}else if(b.type==hmUI.widget.BUTTON)ctx.font=""+a.text_size+"px \u9ed1\u4f53",ctx.lineWidth=1,ctx.fillStyle=converColorNum(a.normal_color),ctx.roundRect(a.x,a.y,a.w,a.h,a.radius?a.radius:0).fill(),ctx.fillStyle=converColorNum(a.color),ctx.textBaseline="middle",ctx.textAlign="center",ctx.fillText(a.text,a.x+a.w/2,a.y+a.h/2);else if(b.type==hmUI.widget.FILL_RECT)ctx.lineWidth=1,ctx.fillStyle=converColorNum(a.color),ctx.roundRect(a.x,a.y,a.w,a.h,a.radius?a.radius:0).fill();else if(b.type==hmUI.widget.STROKE_RECT)ctx.lineWidth=1,ctx.strokeStyle=converColorNum(a.color),ctx.roundRect(a.x,a.y,a.w,a.h,a.radius?a.radius:0).stroke();else if(b.type==hmUI.widget.ARC_PROGRESS){ctx.beginPath();var g=a.level,e=a.center_y;g||(g=100);a.type&&(g=render_data_level[a.type]);var f=parseFloat(a.start_angle-90),h=parseFloat(a.end_angle-90),h=(h-f)*g/100+f,g=!1;h<f&&(g=!0);ctx.arc(a.center_x,e,a.radius,2*Math.PI*f/360,2*Math.PI*h/360,g);ctx.lineWidth=a.line_width;ctx.strokeStyle=converColorNum(a.color);ctx.stroke()}else if(render_config[b.type]&&(b.render_data||(b.render_data={}),e=render_config[b.type].render_img(a,render_data,b.render_data)))if(e instanceof Array){if(0<e.length){f=[];for(h=0;h<e.length;h++)(g=e[h])&&g.src&&(f.push(g),b.type==hmUI.widget.IMG?renderImage(ctx,g,b):renderImage(ctx,g));setImagesWH(f,b,a)}}else e.src&&(b.type==hmUI.widget.IMG?renderImage(ctx,e,b):renderImage(ctx,e),setImagesWH([e],b,a));b.clickflag?(ctx.lineWidth=1,ctx.strokeStyle="#ef5350",ctx.strokeRect(b.x,b.y,b.w,b.h)):engine_set.showBox&&(ctx.lineWidth=1,ctx.strokeStyle="#1E90FF",ctx.strokeRect(b.x,b.y,b.w,b.h))}}}(new Date).getTime()}}function setImagesWH(c,d,b){if(b.w)d.w=b.w;else if(c&&0<c.length){var a=c[c.length-1];d.w=a.x+getImageWidth(a.src)-c[0].x}b.h?d.h=b.h:c&&0<c.length&&(d.h=getImageHeight(c[0].src))}function renderImage(c,d,b){var a=IMAGE_PRE+d.src;if(imageMap[a]){var a=imageMap[a],e=d.center_x,f=d.center_y;c.moveTo(0,0);d.angle&&(c.translate(e,f),c.rotate(d.angle*Math.PI/180),c.translate(-1*e,-1*f));c.drawImage(a,d.x,d.y);d.angle&&(c.translate(e,f),c.rotate(d.angle*Math.PI/180*-1),c.translate(-1*e,-1*f));b&&(d.w||(b.w=a.width),d.h||(b.h=a.height))}else loadImg(a)}function isNumber(c){return/^[0-9]+.?[0-9]*/.test(c)?!0:!1}function converColorNum(c){if(0==c)return"#000000";if(!c)return c;c=isNumber(c)?Number(c).toString(16):c.substring(2);5==c.length?c="0"+c:4==c.length&&(c="00"+c);return"#"+c}CanvasRenderingContext2D.prototype.roundRect=function(c,d,b,a,e){b<2*e&&(e=b/2);a<2*e&&(e=a/2);this.beginPath();this.moveTo(c+e,d);this.arcTo(c+b,d,c+b,d+a,e);this.arcTo(c+b,d+a,c,d+a,e);this.arcTo(c,d+a,c,d,e);this.arcTo(c,d,c+b,d,e);this.closePath();return this};CanvasRenderingContext2D.prototype.fillTextMuilline=function(c,d){var b=d.text,a=d.x,e=d.y,f=d.text_size,g=d.w,h=d.h;(d=d.line_space)||(d=0);c.font=""+f+"px \u9ed1\u4f53";c.textAlign="left";c.textBaseline="top";f+=d;d=1;for(var k=0;""!=b;){for(;d<=b.length&&c.measureText(b.substr(0,d)).width<g;)d++;d-1==b.length?(c.fillText(b,a,e+k*f),b=""):(c.fillText(b.substr(0,d-1),a,e+k*f),h&&(k+2)*f>h&&(b=""),b=b.slice(d-1));k++;d=1}};var loading=!1,loadingArray=[];function loadNextImg(){loading=!1;0<loadingArray.length&&(loadImg(loadingArray[0]),loadingArray.splice(0,1))}function loadImg(c){if(!c||"watchface/assets/undefined"==c)debugger;if(loading)loadingArray.push(c);else{loading=!0;var d=new Image;d.src=c;d.onload=function(){imageMap[c]=d;loadNextImg()};d.onerror=function(){console.log("error load img "+c);loadNextImg()}}}function getInVisibleWds(){for(var c={},d=0;d<hmUI.widgets.length;d++){var b=hmUI.widgets[d];if(!b.visible||c[b.id+""])if(c[b.id+""]=!0,b.subWds&&0<b.subWds.length)for(var a=0;a<b.subWds.length;a++)c[b.subWds[a].id+""]=!0}return c}var timers=setInterval(function(){refreshCanvasUI()},50);console.log(timers);function switchRefreshCanvasUI(){timers?(clearInterval(timers),timers="",$("#switchCanvas").html("\u5f00\u59cb\u5237\u65b0")):(timers=setInterval(function(){refreshCanvasUI()},50),$("#switchCanvas").html("\u505c\u6b62\u5237\u65b0"))};